#!/bin/bash
# Pre-commit hook template for Bayesian Data Analysis project
#
# Installation:
#   cp .git-hooks/pre-commit.template .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# This hook reminds you to update documentation when committing significant changes.

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-commit checks...${NC}"

# Check if any notebooks were modified
NOTEBOOKS_CHANGED=$(git diff --cached --name-only | grep '\.ipynb$')

# Check if documentation files exist and are staged
CLAUDE_MD_STAGED=$(git diff --cached --name-only | grep 'CLAUDE\.md$')
TODO_MD_STAGED=$(git diff --cached --name-only | grep 'TODO\.md$')
MEMORY_MD_STAGED=$(git diff --cached --name-only | grep 'MEMORY\.md$')

# If notebooks changed but no docs updated, remind the user
if [ -n "$NOTEBOOKS_CHANGED" ]; then
    echo -e "${YELLOW}ðŸ““ Jupyter notebooks modified:${NC}"
    echo "$NOTEBOOKS_CHANGED" | sed 's/^/  - /'
    echo ""

    # Check if documentation should be updated
    DOC_UPDATE_NEEDED=false

    if [ -z "$CLAUDE_MD_STAGED" ]; then
        echo -e "${YELLOW}âš ï¸  Consider updating CLAUDE.md or chapter-specific CLAUDE.md${NC}"
        DOC_UPDATE_NEEDED=true
    fi

    if [ -z "$TODO_MD_STAGED" ]; then
        echo -e "${YELLOW}âš ï¸  Consider updating TODO.md with progress${NC}"
        DOC_UPDATE_NEEDED=true
    fi

    # Only warn about MEMORY.md if this is a significant change
    HOMEWORK_CHANGED=$(echo "$NOTEBOOKS_CHANGED" | grep -i 'homework')
    NEW_CONCEPT=$(echo "$NOTEBOOKS_CHANGED" | grep -v 'checkpoint')

    if [ -n "$HOMEWORK_CHANGED" ] || [ -n "$NEW_CONCEPT" ]; then
        if [ -z "$MEMORY_MD_STAGED" ]; then
            echo -e "${YELLOW}âš ï¸  Consider updating MEMORY.md if you learned new patterns${NC}"
            DOC_UPDATE_NEEDED=true
        fi
    fi

    if [ "$DOC_UPDATE_NEEDED" = true ]; then
        echo ""
        echo -e "${YELLOW}Documentation update checklist:${NC}"
        echo "  1. Update TODO.md - mark completed tasks, add new ones"
        echo "  2. Update chapter CLAUDE.md - add new concepts/notebooks"
        echo "  3. Update MEMORY.md - add new patterns/learnings (if applicable)"
        echo "  4. Update root CLAUDE.md - if project structure changed"
        echo ""
        echo -e "${YELLOW}Continue with commit? (y/n)${NC}"
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            echo -e "${RED}Commit aborted. Update documentation and try again.${NC}"
            exit 1
        fi
    fi
fi

# Check for large files (notebooks can get big)
LARGE_FILES=$(git diff --cached --name-only | while read file; do
    if [ -f "$file" ]; then
        size=$(du -k "$file" | cut -f1)
        if [ $size -gt 1024 ]; then  # > 1MB
            echo "$file ($size KB)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  Large files detected (>1MB):${NC}"
    echo "$LARGE_FILES" | sed 's/^/  - /'
    echo ""
    echo -e "${YELLOW}Consider clearing notebook outputs if this is a notebook.${NC}"
    echo -e "${YELLOW}Continue? (y/n)${NC}"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo -e "${RED}Commit aborted.${NC}"
        exit 1
    fi
fi

# Suggest good commit message patterns
echo ""
echo -e "${GREEN}âœ“ Pre-commit checks passed${NC}"
echo ""
echo -e "${GREEN}Good commit message examples:${NC}"
echo "  - 'complete chapter 6 homework problems 6H3-6H5'"
echo "  - 'add multicollinearity visualization fix'"
echo "  - 'update quap.py to handle edge cases'"
echo "  - 'chapter 6: complete collider bias section'"
echo ""

exit 0
